# CLAUDE.md - Clara Provider App (iOS)

This file provides guidance to Claude Code when working with the Clara Provider iOS app.

## Project Overview

Clara Provider App is an iOS application that allows healthcare providers to review, respond to, flag, and escalate patient conversations generated by the Clara AI pediatric triage system.

## Project Structure

```
/Users/dochobbs/Downloads/Consult/GIT/vhs/clara-provider-app/
├── clara-provider-app/
│   ├── Views/
│   │   ├── ConversationDetailView.swift      # Main detail view with responses
│   │   ├── ConversationListView.swift        # List of conversations
│   │   ├── ProviderReplyBox.swift            # Reply/response UI
│   │   ├── HomeView.swift                    # Main home screen
│   │   └── SettingsView.swift                # App settings
│   ├── Store/
│   │   ├── ProviderConversationStore.swift   # Main state management
│   │   └── AuthenticationStore.swift         # Authentication logic
│   ├── Services/
│   │   ├── ProviderSupabaseService.swift     # Supabase API integration
│   │   ├── AuthenticationService.swift       # Auth service
│   │   └── NetworkMonitor.swift              # Network connectivity
│   ├── Models/
│   │   ├── ProviderReviewRequestDetail.swift # Review request data model
│   │   └── [Other models]
│   ├── Utilities/
│   │   ├── FontExtensions.swift              # Custom fonts (RethinkSans)
│   │   ├── ColorExtensions.swift             # Color themes
│   │   └── DateFormatters.swift              # Date utilities
│   ├── clara-provider-appApp.swift           # App entry point
│   └── Assets.xcassets/
├── clara-provider-appTests/                  # Unit tests
└── project.pbxproj                           # Xcode project config
```

## Key Features

### 1. Conversation Management
- **List View:** All provider review requests with status filtering
- **Detail View:** Full conversation with provider response options
- **Statuses:** pending, responded, flagged, escalated, dismissed

### 2. Provider Review Actions
- **Respond:** Submit a review with optional response text and urgency level
- **Flag:** Mark conversation for review with optional reason (≤500 chars)
- **Escalate:** Mark as requiring urgent attention
- **Dismiss:** Mark as reviewed but no action needed
- **Unflag:** Restore to previous status and clear flag reason

### 3. Data Flow
- **Backend:** Supabase PostgreSQL
- **Authentication:** Face ID / passcode
- **API:** REST endpoints via Supabase service
- **State Management:** SwiftUI @Published properties in Store

### 4. UI Components
- **RethinkSans Font:** Custom font family used throughout
- **Color Scheme:** Dark mode support with adaptive colors
- **Status Badges:** Color-coded by status (orange=pending, green=responded, orange=flagged, red=escalated)
- **Provider Review Box:** Shows status, response, and flag reason (if flagged)

## Development Commands

### Build and Run
```bash
# Open Xcode project
open /Users/dochobbs/Downloads/Consult/GIT/vhs/clara-provider-app/clara-provider-app.xcodeproj

# Or build from command line
xcodebuild build -scheme "Clara Provider" -destination "generic/platform=iOS"

# Run on simulator
xcodebuild build -scheme "Clara Provider" -destination "platform=iOS Simulator,name=iPhone 15"
```

### Testing
```bash
# Run unit tests
xcodebuild test -scheme "Clara Provider" -destination "platform=iOS Simulator,name=iPhone 15"
```

## Important Files and Locations

| File | Purpose | Key Lines |
|------|---------|-----------|
| ConversationDetailView.swift | Main detail view logic | 85-102 (reply box), 107-133 (flag button), 139-196 (flag modal), 907-1013 (review box) |
| ProviderReplyBox.swift | Response/reply text entry | Response submission logic |
| ProviderConversationStore.swift | State management | 448-536 (flagConversation), 540-587 (unflagConversation) |
| ProviderSupabaseService.swift | API calls | 189-211 (updateReviewStatus), 214-234 (updateFlagReason) |
| ProviderReviewRequestDetail.swift | Data model | status, flagReason, providerResponse fields |
| ConversationListView.swift | List view & filtering | 31-62 (filters), 229-236 (row display), 296-322 (status badge) |

## Code Conventions

### Swift/SwiftUI
- **State Management:** Use ProviderConversationStore as single source of truth
- **Async/Await:** Use `async/await` for all network calls
- **MainActor:** Use `@MainActor.run` for UI updates from background threads
- **View Modifiers:** Custom fonts with `.rethinkSans()` and `.rethinkSansBold()`
- **Error Handling:** Throw/catch with NSError or custom error types

### Data Flow
1. User action in View triggers Store method
2. Store makes Supabase API call via Service
3. Service returns result or throws error
4. Store updates local @Published properties on MainActor
5. SwiftUI automatically updates Views based on @Published changes

### Naming Conventions
- Views: `*View.swift` (e.g., `ConversationDetailView.swift`)
- ViewModels/Stores: `*Store.swift` (e.g., `ProviderConversationStore.swift`)
- Services: `*Service.swift` (e.g., `ProviderSupabaseService.swift`)
- Models: `*.swift` with clear names (e.g., `ProviderReviewRequestDetail.swift`)
- Private properties: prefix with `_` or use `private`
- Published properties: no prefix, used by Views

## Flag/Unflag Behavior

### Current Flow
1. **Flag Action:**
   - User taps flag button in top-right
   - Modal appears for optional reason (≤500 chars)
   - Original status is saved to UserDefaults: `original_status_{uuid}`
   - Status changed to "flagged" in Supabase
   - Flag reason saved in Supabase
   - Local cache updated immediately

2. **Unflag Action:**
   - User taps filled flag button (when already flagged)
   - Original status retrieved from UserDefaults
   - Status restored to original in Supabase
   - Flag reason cleared in Supabase
   - Local cache updated
   - UserDefaults entry cleaned up

3. **Reply Box Visibility:**
   - Shows only when `status == "pending"`
   - Hidden for all other statuses (responded, flagged, escalated, dismissed)
   - **Known Issue:** When unflagging from "flagged" → "pending", reply box reappears

4. **Provider Review Box:**
   - Appears when status != "pending"
   - Shows status, timestamp, provider response text, and flag reason (if flagged)
   - Green box for "responded", orange for "flagged", red for "escalated"

### Known Issues
- **Issue #1:** Unflagging restores to "pending" state, which shows reply box again (confusing UX)
- **Issue #2:** Flagging a "pending" conversation with a reply shows "Flagged" status instead of preserving the response
- **Proposed Fix:** Implement swipe-to-flag on home screen, or hide reply box when status is "flagged"

## API Endpoints

All endpoints are Supabase REST API via `ProviderSupabaseService`:

```
PATCH /rest/v1/provider_review_requests?conversation_id=eq.{uuid}
  - Update status: {"status": "flagged"|"responded"|"escalated"|"pending"|"dismissed"}
  - Update flag reason: {"flag_reason": "string"|null}
  - Update responded_at timestamp when responding

Headers:
  - apikey: [Supabase API key from environment]
  - Authorization: Bearer [User JWT token]
  - Content-Type: application/json
```

## Authentication

- **Method:** Face ID or Passcode
- **Storage:** Secure Enclave (iOS Keychain)
- **JWT Tokens:** Handled by Supabase auth
- **Implementation:** AuthenticationService & AuthenticationStore

## Build & Deployment

- **Minimum iOS Version:** iOS 15.0
- **Target Device:** iPhone (iPad optional)
- **Architecture:** SwiftUI (no UIKit)
- **Package Manager:** SPM (Swift Package Manager) or CocoaPods
- **CI/CD:** Check Xcode project settings

## Testing Strategy

### Manual Testing Checklist
- [ ] User can log in with Face ID/passcode
- [ ] Conversation list shows all review requests
- [ ] Status filtering works (pending, responded, flagged, etc.)
- [ ] Can respond to a conversation
- [ ] Can flag a conversation with optional reason
- [ ] Can unflag a flagged conversation
- [ ] Provider review box shows correct status and content
- [ ] Provider response text is preserved when flagging/unflagging
- [ ] Reply box appears only when status is "pending"
- [ ] Network errors are handled gracefully
- [ ] App works offline (graceful degradation)

### Unit Testing Areas
- Store state management (flag/unflag logic)
- Data model decoding (Supabase response parsing)
- Date formatting utilities
- Network request construction

## Git Workflow

### Branch Strategy
- **Main branch:** `main` (production-ready)
- **Feature branches:** `feature/description` for new features
- **Bug fixes:** `fix/description` for bug fixes

### Commit Messages
- Start with type: `FEATURE:`, `FIX:`, `REFACTOR:`, `DOCS:`
- Example: `FIX: Preserve provider response when unflagging conversation`
- Include why, not just what
- Reference related issues if applicable

### Push Frequency
- Push only when feature/fix is complete and builds successfully
- Test thoroughly before pushing
- Keep commits related and atomic

## Environment Setup

### Required
- Xcode 15.0 or later
- iOS 15.0 minimum deployment target
- Swift 5.9 or later

### Configuration Files
- `.env` files (if used for API keys)
- Supabase project credentials
- API key configuration (in code or environment)

## Helpful Resources

### Within Project
- Review `ConversationDetailView.swift` for UI layout
- Check `ProviderConversationStore.swift` for state management patterns
- See `ProviderSupabaseService.swift` for API integration examples

### External
- SwiftUI Docs: https://developer.apple.com/swiftui/
- Combine Framework: https://developer.apple.com/combine/
- Supabase Swift SDK: https://github.com/supabase/supabase-swift

## Current Working Tasks

### High Priority
1. **Flag/Unflag UX Issue** - Fix reply box appearing when unflagging
   - Option 1: Hide reply box when status is "flagged"
   - Option 2: Implement swipe-to-flag on home screen
   - Option 3: Change restoration logic to preserve review state

2. **Status Handling** - Ensure all conversation statuses are properly handled
   - pending: Show reply box
   - responded: Show response box, hide reply box
   - flagged: Show flag reason, hide reply box
   - escalated: Show escalation indicator
   - dismissed: Show dismissal indicator

## Notes for Claude Code

When working with this project:

1. **Always check file paths:** Use absolute paths like `/Users/dochobbs/Downloads/Consult/GIT/vhs/clara-provider-app/`
2. **Understand data flow:** Changes in Store affect all Views subscribed to it
3. **Test state changes:** Flag/unflag/respond all affect conversation status and visibility
4. **Preserve data:** Don't lose provider responses or flag reasons when making changes
5. **Consider UI:** Changes to visibility logic affect what users see immediately
6. **Check Supabase:** API calls are the source of truth; local cache must stay in sync

---

**Last Updated:** November 6, 2025
**Status:** Production app with active flag/unflag UX refinements
**Next Action:** Implement flag/unflag UX improvement (Option 1, 2, or 3)
